{"title":"UE5文心一言插件","uid":"9918a2b9f61566415c27ac62b26c0656","slug":"7_19_UE5文心一言插件","date":"2024-02-29T06:19:33.432Z","updated":"2024-02-29T06:18:30.736Z","comments":true,"path":"api/articles/7_19_UE5文心一言插件.json","keywords":null,"cover":"https://cdn.jsdelivr.net/gh/FHangH/FHangBlogCDN_03@master/Aurora_ (41).webp","content":"<h1 id=\"UE5文心一言插件\"><a href=\"#UE5文心一言插件\" class=\"headerlink\" title=\"UE5文心一言插件\"></a>UE5文心一言插件</h1><p>[toc]</p>\n<h3 id=\"0-github\"><a href=\"#0-github\" class=\"headerlink\" title=\"0. github\"></a>0. github</h3><p><a href=\"https://github.com/FHangH/WenXinYiYan\">UE5文心一言插件</a></p>\n<h3 id=\"1-结构设计\"><a href=\"#1-结构设计\" class=\"headerlink\" title=\"1. 结构设计\"></a>1. 结构设计</h3><p><code>WXYY.h</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">pragma</span> once</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;WXYY.generated.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">DECLARE_LOG_CATEGORY_EXTERN</span>(LogWenXin, Log, All);</span><br><span class=\"line\"><span class=\"built_in\">DEFINE_LOG_CATEGORY</span>(LogWenXin);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">UENUM</span>(BlueprintType)</span><br><span class=\"line\"><span class=\"keyword\">enum class</span> <span class=\"title class_\">ERole</span> : uint8</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"function\">ER_User\t\t\t<span class=\"title\">UMETA</span><span class=\"params\">(Displayname=<span class=\"string\">&quot;user&quot;</span>)</span>,</span></span><br><span class=\"line\"><span class=\"function\">\tER_Assistant\t<span class=\"title\">UMETA</span><span class=\"params\">(Displayname=<span class=\"string\">&quot;assistant&quot;</span>)</span></span></span><br><span class=\"line\"><span class=\"function\">&#125;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">USTRUCT</span>(BlueprintType)</span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">FChatMessage</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">GENERATED_USTRUCT_BODY</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, meta=(AllowPrivateAccess=<span class=\"literal\">true</span>))</span><br><span class=\"line\">\tERole Role;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">UPROPERTY</span>(EditAnywhere, BlueprintReadWrite, meta=(AllowPrivateAccess=<span class=\"literal\">true</span>))</span><br><span class=\"line\">\tFString Content;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">FChatMessage</span>() : <span class=\"built_in\">Role</span>(ERole::ER_User), <span class=\"built_in\">Content</span>(<span class=\"string\">&quot;&quot;</span>)&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">explicit</span> <span class=\"title\">FChatMessage</span><span class=\"params\">(<span class=\"type\">const</span> ERole NewRole)</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\tRole = NewRole;</span><br><span class=\"line\">\t\tContent = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">USTRUCT</span>(BlueprintType)</span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">FWXConfigKey</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">GENERATED_USTRUCT_BODY</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">\tFString AppID;</span><br><span class=\"line\">\tFString AppSecret;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">FWXConfigKey</span>() : <span class=\"built_in\">AppID</span>(<span class=\"string\">&quot;&quot;</span>), <span class=\"built_in\">AppSecret</span>(<span class=\"string\">&quot;&quot;</span>)&#123;&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">UCLASS</span>()</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">UWXYY</span> : <span class=\"keyword\">public</span> UObject</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">GENERATED_BODY</span>()</span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"type\">static</span> FString AccessToken;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">static</span> FORCEINLINE <span class=\"type\">void</span> <span class=\"title\">SetAccessToken</span><span class=\"params\">(<span class=\"type\">const</span> FString&amp; Token)</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\tAccessToken = Token;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">UFUNCTION</span>(BlueprintPure, Category=<span class=\"string\">&quot;FH|WXYY&quot;</span>)</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">static</span> FORCEINLINE FString <span class=\"title\">ConverToStr</span><span class=\"params\">(<span class=\"type\">const</span> ERole&amp; Role)</span></span></span><br><span class=\"line\"><span class=\"function\">\t</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> Role == ERole::ER_User ? <span class=\"built_in\">FString</span>(<span class=\"string\">&quot;user&quot;</span>) : Role == ERole::ER_Assistant ? <span class=\"built_in\">FString</span>(<span class=\"string\">&quot;assistant&quot;</span>) : </span><br><span class=\"line\">        <span class=\"built_in\">FString</span>(<span class=\"string\">&quot;user&quot;</span>);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">FString UWXYY::AccessToken&#123;&#125;;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"2-获取AccessToken\"><a href=\"#2-获取AccessToken\" class=\"headerlink\" title=\"2. 获取AccessToken\"></a>2. 获取AccessToken</h3><p><code>WXYY_AccessToken.h</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">pragma</span> once</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;CoreMinimal.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;HttpModule.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;Interfaces/IHttpRequest.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;Kismet/BlueprintAsyncActionBase.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;WXYY_AccessToken.generated.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FResponseAccessTokenDelegate, FString, Result);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">UCLASS</span>()</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FH_WENXINYIIYAN_API</span> UGetAccessToken : <span class=\"keyword\">public</span> UBlueprintAsyncActionBase</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">GENERATED_BODY</span>()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"built_in\">UPROPERTY</span>(BlueprintAssignable)</span><br><span class=\"line\">\tFResponseAccessTokenDelegate OnSuccess;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">UPROPERTY</span>(BlueprintAssignable)</span><br><span class=\"line\">\tFResponseAccessTokenDelegate OnFail;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">UFUNCTION</span>(BlueprintCallable, Category=<span class=\"string\">&quot;FH|WXYY&quot;</span>, meta=(BlueprintInternalUseOnly=<span class=\"string\">&quot;true&quot;</span>))</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">static</span> UGetAccessToken* <span class=\"title\">GetAccessToken</span><span class=\"params\">(FString API, FString Secret)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\tTSharedRef&lt;IHttpRequest, ESPMode::ThreadSafe&gt; RequestToken = FHttpModule::<span class=\"built_in\">Get</span>().<span class=\"built_in\">CreateRequest</span>();</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">OnHttpsRequestToken</span><span class=\"params\">(<span class=\"type\">const</span> FString&amp; API, <span class=\"type\">const</span> FString&amp; Secret)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">OnDeserializeResponse</span><span class=\"params\">(FHttpRequestPtr Request, FHttpResponsePtr Response, <span class=\"type\">const</span> <span class=\"type\">bool</span> Success)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\">FORCEINLINE <span class=\"type\">bool</span> <span class=\"title\">IsRequestProcessing</span><span class=\"params\">()</span> <span class=\"type\">const</span> </span>&#123;<span class=\"keyword\">return</span> RequestToken-&gt;<span class=\"built_in\">GetStatus</span>() == EHttpRequestStatus::Processing;&#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n\n\n<p><code>WXYY_AccessToken.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;WXYY_AccessToken.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;HttpManager.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;HttpModule.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;Interfaces/IHttpResponse.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;WXYY.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\">UGetAccessToken* <span class=\"title\">UGetAccessToken::GetAccessToken</span><span class=\"params\">(FString API, FString Secret)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"keyword\">auto</span> RequestTokenObject = <span class=\"built_in\">NewObject</span>&lt;UGetAccessToken&gt;();</span><br><span class=\"line\">\tRequestTokenObject-&gt;<span class=\"built_in\">OnHttpsRequestToken</span>(API, Secret);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> RequestTokenObject;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">UGetAccessToken::OnHttpsRequestToken</span><span class=\"params\">(<span class=\"type\">const</span> FString&amp; API, <span class=\"type\">const</span> FString&amp; Secret)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">AddToRoot</span>();</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"keyword\">auto</span> URL =</span><br><span class=\"line\">\t\tFString::<span class=\"built_in\">Printf</span>(</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;https://aip.baidubce.com/oauth/2.0/token?client_id=%s&amp;client_secret=%s&amp;grant_type=client_credentials&quot;</span>),</span><br><span class=\"line\">\t\t\t*API, *Secret);</span><br><span class=\"line\"></span><br><span class=\"line\">\tRequestToken = FHttpModule::<span class=\"built_in\">Get</span>().<span class=\"built_in\">CreateRequest</span>();</span><br><span class=\"line\">\tRequestToken-&gt;<span class=\"built_in\">SetVerb</span>(<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;POST&quot;</span>));</span><br><span class=\"line\">\tRequestToken-&gt;<span class=\"built_in\">SetURL</span>(URL);</span><br><span class=\"line\">\tRequestToken-&gt;<span class=\"built_in\">SetHeader</span>(<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Content-Type&quot;</span>), <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;application/json&quot;</span>));</span><br><span class=\"line\">\tRequestToken-&gt;<span class=\"built_in\">SetHeader</span>(<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Accept&quot;</span>), <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;application/json&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">\tRequestToken-&gt;<span class=\"built_in\">OnProcessRequestComplete</span>().<span class=\"built_in\">BindUObject</span>(<span class=\"keyword\">this</span>, &amp;UGetAccessToken::OnDeserializeResponse);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (RequestToken-&gt;<span class=\"built_in\">ProcessRequest</span>() || <span class=\"built_in\">IsRequestProcessing</span>())</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan Start ======&quot;</span>));</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Process&quot;</span>));</span><br><span class=\"line\">\t\tFHttpModule::<span class=\"built_in\">Get</span>().<span class=\"built_in\">GetHttpManager</span>().<span class=\"built_in\">Tick</span>(<span class=\"number\">0.f</span>);</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (RequestToken-&gt;<span class=\"built_in\">GetStatus</span>() == EHttpRequestStatus::Failed)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tOnFail.<span class=\"built_in\">Broadcast</span>(<span class=\"string\">&quot;null&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Fail&quot;</span>));</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan End ======&quot;</span>));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t\t<span class=\"built_in\">RemoveFromRoot</span>();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Complete&quot;</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">UGetAccessToken::OnDeserializeResponse</span><span class=\"params\">(FHttpRequestPtr Request, FHttpResponsePtr Response, <span class=\"type\">const</span> <span class=\"type\">bool</span> Success)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tFString Result;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (Success &amp;&amp; Response-&gt;<span class=\"built_in\">GetResponseCode</span>() == EHttpResponseCodes::Ok)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Response Success&quot;</span>));</span><br><span class=\"line\">\t\t<span class=\"type\">const</span> <span class=\"keyword\">auto</span> ResponseContent = Response-&gt;<span class=\"built_in\">GetContentAsString</span>();</span><br><span class=\"line\">\t\t<span class=\"type\">const</span> <span class=\"keyword\">auto</span> JsonReader = TJsonReaderFactory&lt;&gt;::<span class=\"built_in\">Create</span>(ResponseContent);</span><br><span class=\"line\">    </span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (TSharedPtr&lt;FJsonObject&gt; JsonObject; FJsonSerializer::<span class=\"built_in\">Deserialize</span>(JsonReader, JsonObject))</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Deserialize Response&quot;</span>));</span><br><span class=\"line\">\t\t\tResult = JsonObject-&gt;<span class=\"built_in\">GetStringField</span>(<span class=\"string\">&quot;access_token&quot;</span>);</span><br><span class=\"line\">\t\t\tOnSuccess.<span class=\"built_in\">Broadcast</span>(Result);</span><br><span class=\"line\">\t\t\tUWXYY::<span class=\"built_in\">SetAccessToken</span>(Result);</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Result = %s&quot;</span>), *Result);</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan End ======&quot;</span>));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tOnFail.<span class=\"built_in\">Broadcast</span>(<span class=\"string\">&quot;null&quot;</span>);</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Result = %s&quot;</span>), *Result);</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan End ======&quot;</span>));</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">RemoveFromRoot</span>();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"3-获取对话内容\"><a href=\"#3-获取对话内容\" class=\"headerlink\" title=\"3. 获取对话内容\"></a>3. 获取对话内容</h3><p><code>WXYY_Chat.h</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">pragma</span> once</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;CoreMinimal.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;Kismet/BlueprintAsyncActionBase.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;WXYY.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;Interfaces/IHttpRequest.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;WXYY_Chat.generated.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam</span>(FResponseChatMessage, FChatMessage, ChatMessage);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">UCLASS</span>()</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FH_WENXINYIIYAN_API</span> USendChatMessage : <span class=\"keyword\">public</span> UBlueprintAsyncActionBase</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">GENERATED_BODY</span>()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"built_in\">UPROPERTY</span>(BlueprintAssignable)</span><br><span class=\"line\">\tFResponseChatMessage OnCompleted;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">UPROPERTY</span>(BlueprintAssignable)</span><br><span class=\"line\">\tFResponseChatMessage OnFail;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">UFUNCTION</span>(BlueprintCallable, Category=<span class=\"string\">&quot;FH|WXYY&quot;</span>, meta=(BlueprintInternalUseOnly=<span class=\"string\">&quot;true&quot;</span>))</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">static</span> USendChatMessage* <span class=\"title\">SendChatMessage</span><span class=\"params\">(FChatMessage ChatMessage)</span></span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">UFUNCTION</span>(BlueprintCallable, Category=<span class=\"string\">&quot;FH|WXYY&quot;</span>)</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">CancelMessageRequest</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\t<span class=\"keyword\">inline</span> <span class=\"type\">static</span> USendChatMessage* SendChatHandler = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\">\tTSharedPtr&lt;IHttpRequest, ESPMode::ThreadSafe&gt; RequestChat;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">OnHttpsRequestChatMessage</span><span class=\"params\">(<span class=\"type\">const</span> FChatMessage&amp; ChatMessage)</span></span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">OnDeserializeResponse</span><span class=\"params\">(FHttpRequestPtr Request, FHttpResponsePtr Response, <span class=\"type\">const</span> <span class=\"type\">bool</span> Success)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">bool</span> <span class=\"title\">IsRequestProcessing</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">UCLASS</span>()</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FH_WENXINYIIYAN_API</span> USendChatMessageByStream : <span class=\"keyword\">public</span> UBlueprintAsyncActionBase</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">GENERATED_BODY</span>()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span>:</span><br><span class=\"line\">\t<span class=\"built_in\">UPROPERTY</span>(BlueprintAssignable)</span><br><span class=\"line\">\tFResponseChatMessage OnUpdate;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"built_in\">UPROPERTY</span>(BlueprintAssignable)</span><br><span class=\"line\">\tFResponseChatMessage OnCompleted;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">UPROPERTY</span>(BlueprintAssignable)</span><br><span class=\"line\">\tFResponseChatMessage OnFail;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">UFUNCTION</span>(BlueprintCallable, Category=<span class=\"string\">&quot;FH|WXYY&quot;</span>, meta=(BlueprintInternalUseOnly=<span class=\"string\">&quot;true&quot;</span>))</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">static</span> USendChatMessageByStream* <span class=\"title\">SendChatMessageByStream</span><span class=\"params\">(FChatMessage ChatMessage)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">UFUNCTION</span>(BlueprintCallable, Category=<span class=\"string\">&quot;FH|WXYY&quot;</span>)</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">void</span> <span class=\"title\">CancelStreamMessageRequest</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span>:</span><br><span class=\"line\">\tFString AllResult;</span><br><span class=\"line\">\tFString AllResponse;</span><br><span class=\"line\">\tFString TempResponse;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">inline</span> <span class=\"type\">static</span> USendChatMessageByStream* SendStreamChatHandler = <span class=\"literal\">nullptr</span>;</span><br><span class=\"line\">\tTSharedPtr&lt;IHttpRequest, ESPMode::ThreadSafe&gt; RequestChat;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">OnHttpsRequestChatMessage</span><span class=\"params\">(<span class=\"type\">const</span> FChatMessage&amp; ChatMessage)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">OnUpdateResponse</span><span class=\"params\">(FHttpRequestPtr HttpRequest, int32 BytesSent, int32 BytesReceived)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">OnDeserializeResponseUpdate</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">OnCompletedResponse</span><span class=\"params\">(FHttpRequestPtr Request, FHttpResponsePtr Response, <span class=\"type\">const</span> <span class=\"type\">bool</span> Success)</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"type\">static</span> <span class=\"type\">bool</span> <span class=\"title\">IsRequestProcessing</span><span class=\"params\">()</span></span>;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n\n\n<p><code>WXYY_Chat.cpp</code></p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;WXYY_Chat.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;HttpManager.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;HttpModule.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;Interfaces/IHttpResponse.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Send Chat Message</span></span><br><span class=\"line\"><span class=\"function\">USendChatMessage* <span class=\"title\">USendChatMessage::SendChatMessage</span><span class=\"params\">(FChatMessage ChatMessage)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"keyword\">auto</span> RequestObject = <span class=\"built_in\">NewObject</span>&lt;USendChatMessage&gt;();</span><br><span class=\"line\">\tRequestObject-&gt;<span class=\"built_in\">OnHttpsRequestChatMessage</span>(ChatMessage);</span><br><span class=\"line\">\tSendChatHandler = RequestObject;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> RequestObject;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">USendChatMessage::OnHttpsRequestChatMessage</span><span class=\"params\">(<span class=\"type\">const</span> FChatMessage&amp; ChatMessage)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">AddToRoot</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"keyword\">auto</span> URL =</span><br><span class=\"line\">\t\tFString::<span class=\"built_in\">Printf</span>(</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/eb-instant?access_token=%s&quot;</span>),</span><br><span class=\"line\">\t\t\t*UWXYY::AccessToken);</span><br><span class=\"line\"></span><br><span class=\"line\">\tRequestChat = FHttpModule::<span class=\"built_in\">Get</span>().<span class=\"built_in\">CreateRequest</span>();</span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">SetVerb</span>(<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;POST&quot;</span>));</span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">SetURL</span>(URL);</span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">SetHeader</span>(<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Content-Type&quot;</span>), <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;application/json&quot;</span>));</span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">SetHeader</span>(<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Accept&quot;</span>), <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;application/json&quot;</span>));</span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">SetContentAsString</span>(</span><br><span class=\"line\">\t\tFString::<span class=\"built_in\">Printf</span>(</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;&#123;\\&quot;messages\\&quot;: [&#123;\\&quot;role\\&quot;:\\&quot;%s\\&quot;,\\&quot;content\\&quot;:\\&quot;%s\\&quot;&#125;]&#125;&quot;</span>),</span><br><span class=\"line\">\t\t\t*UWXYY::<span class=\"built_in\">ConverToStr</span>(ChatMessage.Role), *ChatMessage.Content));</span><br><span class=\"line\"></span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">OnProcessRequestComplete</span>().<span class=\"built_in\">BindUObject</span>(<span class=\"keyword\">this</span>, &amp;USendChatMessage::OnDeserializeResponse);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (RequestChat-&gt;<span class=\"built_in\">ProcessRequest</span>() || <span class=\"built_in\">IsRequestProcessing</span>())</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan Start ======&quot;</span>));</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Process&quot;</span>));</span><br><span class=\"line\">\t\tFHttpModule::<span class=\"built_in\">Get</span>().<span class=\"built_in\">GetHttpManager</span>().<span class=\"built_in\">Tick</span>(<span class=\"number\">0.f</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (RequestChat-&gt;<span class=\"built_in\">GetStatus</span>() == EHttpRequestStatus::Failed)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tFChatMessage Message;</span><br><span class=\"line\">\t\t\tMessage.Role = ERole::ER_Assistant;</span><br><span class=\"line\">\t\t\tMessage.Content = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">\t\t\tOnFail.<span class=\"built_in\">Broadcast</span>(Message);</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Fail&quot;</span>));</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan End ======&quot;</span>));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Complete&quot;</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">USendChatMessage::OnDeserializeResponse</span><span class=\"params\">(FHttpRequestPtr Request, FHttpResponsePtr Response, <span class=\"type\">const</span> <span class=\"type\">bool</span> Success)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tFChatMessage ChatMessage;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (Success &amp;&amp; Response-&gt;<span class=\"built_in\">GetResponseCode</span>() == EHttpResponseCodes::Ok)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Response Success&quot;</span>));</span><br><span class=\"line\">\t\t<span class=\"type\">const</span> <span class=\"keyword\">auto</span> ResponseContent = Response-&gt;<span class=\"built_in\">GetContentAsString</span>();</span><br><span class=\"line\">\t\t<span class=\"type\">const</span> <span class=\"keyword\">auto</span> JsonReader = TJsonReaderFactory&lt;&gt;::<span class=\"built_in\">Create</span>(ResponseContent);</span><br><span class=\"line\">    </span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (TSharedPtr&lt;FJsonObject&gt; JsonObject; FJsonSerializer::<span class=\"built_in\">Deserialize</span>(JsonReader, JsonObject))</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Deserialize Response&quot;</span>));</span><br><span class=\"line\">\t\t\tChatMessage.Role = ERole::ER_Assistant;</span><br><span class=\"line\">\t\t\tChatMessage.Content = JsonObject-&gt;<span class=\"built_in\">GetStringField</span>(<span class=\"string\">&quot;result&quot;</span>);</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (ChatMessage.Content == <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t\tOnFail.<span class=\"built_in\">Broadcast</span>(ChatMessage);</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Result = %s : null&quot;</span>), *UWXYY::<span class=\"built_in\">ConverToStr</span>(ChatMessage.Role));</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan End ======&quot;</span>));</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t\t\t\t<span class=\"built_in\">RemoveFromRoot</span>();</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t\tOnCompleted.<span class=\"built_in\">Broadcast</span>(ChatMessage);</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Result = %s : %s&quot;</span>), *UWXYY::<span class=\"built_in\">ConverToStr</span>(ChatMessage.Role), *ChatMessage.Content);</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan End ======&quot;</span>));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tChatMessage.Role = ERole::ER_Assistant;</span><br><span class=\"line\">\t\tChatMessage.Content = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">\t\tOnFail.<span class=\"built_in\">Broadcast</span>(ChatMessage);</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Result = %s : null&quot;</span>), *UWXYY::<span class=\"built_in\">ConverToStr</span>(ChatMessage.Role));</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan End ======&quot;</span>));</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">\t<span class=\"built_in\">RemoveFromRoot</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">USendChatMessage::IsRequestProcessing</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!SendChatHandler || !SendChatHandler-&gt;RequestChat) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> SendChatHandler-&gt;RequestChat-&gt;<span class=\"built_in\">GetStatus</span>() == EHttpRequestStatus::Processing;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">USendChatMessage::CancelMessageRequest</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!SendChatHandler || !SendChatHandler-&gt;RequestChat) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (SendChatHandler-&gt;RequestChat-&gt;<span class=\"built_in\">GetStatus</span>() == EHttpRequestStatus::Processing)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tSendChatHandler-&gt;RequestChat-&gt;<span class=\"built_in\">CancelRequest</span>();</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Cancle&quot;</span>))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Send Chat Message By Stream</span></span><br><span class=\"line\"><span class=\"function\">USendChatMessageByStream* <span class=\"title\">USendChatMessageByStream::SendChatMessageByStream</span><span class=\"params\">(FChatMessage ChatMessage)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"keyword\">auto</span> RequestObject = <span class=\"built_in\">NewObject</span>&lt;USendChatMessageByStream&gt;();</span><br><span class=\"line\">\tRequestObject-&gt;<span class=\"built_in\">OnHttpsRequestChatMessage</span>(ChatMessage);</span><br><span class=\"line\">\tSendStreamChatHandler = RequestObject;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> RequestObject;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">USendChatMessageByStream::OnHttpsRequestChatMessage</span><span class=\"params\">(<span class=\"type\">const</span> FChatMessage&amp; ChatMessage)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">AddToRoot</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\tAllResult = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">\tTempResponse = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">\tAllResponse = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"keyword\">auto</span> URL =</span><br><span class=\"line\">\t\tFString::<span class=\"built_in\">Printf</span>(</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;https://aip.baidubce.com/rpc/2.0/ai_custom/v1/wenxinworkshop/chat/eb-instant?access_token=%s&quot;</span>),</span><br><span class=\"line\">\t\t\t*UWXYY::AccessToken);</span><br><span class=\"line\"></span><br><span class=\"line\">\tRequestChat = FHttpModule::<span class=\"built_in\">Get</span>().<span class=\"built_in\">CreateRequest</span>();</span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">SetVerb</span>(<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;POST&quot;</span>));</span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">SetURL</span>(URL);</span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">SetHeader</span>(<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Content-Type&quot;</span>), <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;application/json&quot;</span>));</span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">SetHeader</span>(<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Accept&quot;</span>), <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;application/json&quot;</span>));</span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">SetContentAsString</span>(</span><br><span class=\"line\">\t\tFString::<span class=\"built_in\">Printf</span>(</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;&#123;\\&quot;messages\\&quot;: [&#123;\\&quot;role\\&quot;:\\&quot;%s\\&quot;,\\&quot;content\\&quot;:\\&quot;%s\\&quot;&#125;],\\&quot;stream\\&quot;:true&#125;&quot;</span>),</span><br><span class=\"line\">\t\t\t*UWXYY::<span class=\"built_in\">ConverToStr</span>(ChatMessage.Role), *ChatMessage.Content));</span><br><span class=\"line\"></span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">OnRequestProgress</span>().<span class=\"built_in\">BindUObject</span>(<span class=\"keyword\">this</span>, &amp;USendChatMessageByStream::OnUpdateResponse);</span><br><span class=\"line\">\tRequestChat-&gt;<span class=\"built_in\">OnProcessRequestComplete</span>().<span class=\"built_in\">BindUObject</span>(<span class=\"keyword\">this</span>, &amp;USendChatMessageByStream::OnCompletedResponse);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (RequestChat-&gt;<span class=\"built_in\">ProcessRequest</span>() || <span class=\"built_in\">IsRequestProcessing</span>())</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan Start ======&quot;</span>));</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Stream Process&quot;</span>));</span><br><span class=\"line\">\t\tFHttpModule::<span class=\"built_in\">Get</span>().<span class=\"built_in\">GetHttpManager</span>().<span class=\"built_in\">Tick</span>(<span class=\"number\">0.f</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (RequestChat-&gt;<span class=\"built_in\">GetStatus</span>() == EHttpRequestStatus::Failed)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tFChatMessage Message;</span><br><span class=\"line\">\t\t\tMessage.Role = ERole::ER_Assistant;</span><br><span class=\"line\">\t\t\tMessage.Content = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">\t\t\tOnFail.<span class=\"built_in\">Broadcast</span>(Message);</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Stream Fail&quot;</span>));</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan End ======&quot;</span>));</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Stream Complete&quot;</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">USendChatMessageByStream::OnUpdateResponse</span><span class=\"params\">(FHttpRequestPtr HttpRequest, int32 BytesSent, int32 BytesReceived)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Process By Stream&quot;</span>));</span><br><span class=\"line\">\t<span class=\"type\">const</span> <span class=\"keyword\">auto</span> Response = HttpRequest-&gt;<span class=\"built_in\">GetResponse</span>()-&gt;<span class=\"built_in\">GetContentAsString</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (AllResponse.<span class=\"built_in\">IsEmpty</span>())</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tAllResponse = TempResponse = Response;</span><br><span class=\"line\">\t\t<span class=\"built_in\">OnDeserializeResponseUpdate</span>();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tTempResponse = Response;</span><br><span class=\"line\">\t\tTempResponse.<span class=\"built_in\">RemoveFromStart</span>(AllResponse);</span><br><span class=\"line\">\t\t<span class=\"built_in\">OnDeserializeResponseUpdate</span>();</span><br><span class=\"line\">\t\tAllResponse = Response;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">USendChatMessageByStream::OnDeserializeResponseUpdate</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (TempResponse.<span class=\"built_in\">StartsWith</span>(<span class=\"string\">&quot;data:&quot;</span>))</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">auto</span> JsonData = TempResponse.<span class=\"built_in\">RightChop</span>(<span class=\"number\">6</span>);</span><br><span class=\"line\">\t\tJsonData.<span class=\"built_in\">TrimStartAndEndInline</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"type\">const</span> <span class=\"keyword\">auto</span> JsonReader = TJsonReaderFactory&lt;&gt;::<span class=\"built_in\">Create</span>(JsonData);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (TSharedPtr&lt;FJsonObject&gt; JsonObject; FJsonSerializer::<span class=\"built_in\">Deserialize</span>(JsonReader, JsonObject))</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Deserialize Stream Response&quot;</span>));</span><br><span class=\"line\">\t\t\tFChatMessage ChatMessage;</span><br><span class=\"line\">\t\t\tChatMessage.Role = ERole::ER_Assistant;</span><br><span class=\"line\">\t\t\tChatMessage.Content = JsonObject-&gt;<span class=\"built_in\">GetStringField</span>(<span class=\"string\">&quot;result&quot;</span>);</span><br><span class=\"line\">\t\t\tOnUpdate.<span class=\"built_in\">Broadcast</span>(ChatMessage);</span><br><span class=\"line\">\t\t\tAllResult += ChatMessage.Content;</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Stream Result = %s&quot;</span>), *ChatMessage.Content);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">USendChatMessageByStream::OnCompletedResponse</span><span class=\"params\">(FHttpRequestPtr Request, FHttpResponsePtr Response, <span class=\"type\">const</span> <span class=\"type\">bool</span> Success)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\tFChatMessage ChatMessage;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (Success &amp;&amp; Response-&gt;<span class=\"built_in\">GetResponseCode</span>() == EHttpResponseCodes::Ok)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Response Stream Success&quot;</span>));</span><br><span class=\"line\">\t\tChatMessage.Role = ERole::ER_Assistant;</span><br><span class=\"line\">\t\tChatMessage.Content = AllResult;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (ChatMessage.Content == <span class=\"string\">&quot;&quot;</span>)</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t\tOnFail.<span class=\"built_in\">Broadcast</span>(ChatMessage);</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Stream Result = %s : null&quot;</span>), *UWXYY::<span class=\"built_in\">ConverToStr</span>(ChatMessage.Role));</span><br><span class=\"line\">\t\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan End ======&quot;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t<span class=\"built_in\">RemoveFromRoot</span>();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tOnCompleted.<span class=\"built_in\">Broadcast</span>(ChatMessage);</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Stream Result = %s : %s&quot;</span>), *UWXYY::<span class=\"built_in\">ConverToStr</span>(ChatMessage.Role), *ChatMessage.Content);</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan End ======&quot;</span>));</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tChatMessage.Role = ERole::ER_Assistant;</span><br><span class=\"line\">\t\tChatMessage.Content = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">\t\tOnFail.<span class=\"built_in\">Broadcast</span>(ChatMessage);</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Stream Result = %s : null&quot;</span>), *UWXYY::<span class=\"built_in\">ConverToStr</span>(ChatMessage.Role));</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;====== WenXinYiYan End ======&quot;</span>));</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">RemoveFromRoot</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">bool</span> <span class=\"title\">USendChatMessageByStream::IsRequestProcessing</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!SendStreamChatHandler || !SendStreamChatHandler-&gt;RequestChat) <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> SendStreamChatHandler-&gt;RequestChat-&gt;<span class=\"built_in\">GetStatus</span>() == EHttpRequestStatus::Processing;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">USendChatMessageByStream::CancelStreamMessageRequest</span><span class=\"params\">()</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!SendStreamChatHandler || !SendStreamChatHandler-&gt;RequestChat) <span class=\"keyword\">return</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (SendStreamChatHandler-&gt;RequestChat-&gt;<span class=\"built_in\">GetStatus</span>() == EHttpRequestStatus::Processing)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\tSendStreamChatHandler-&gt;RequestChat-&gt;<span class=\"built_in\">CancelRequest</span>();</span><br><span class=\"line\">\t\t<span class=\"built_in\">UE_LOG</span>(LogWenXin, Warning, <span class=\"built_in\">TEXT</span>(<span class=\"string\">&quot;Request Cancle&quot;</span>))</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n","text":"UE5文心一言插件[toc] 0. githubUE5文心一言插件 1. 结构设计WXYY.h 12345678910111213141516171819202...","permalink":"/post/7_19_UE5文心一言插件","photos":[],"count_time":{"symbolsCount":"19k","symbolsTime":"17 mins."},"categories":[{"name":"UnrealEngine","slug":"UnrealEngine","count":23,"path":"api/categories/UnrealEngine.json"},{"name":"Plugin","slug":"UnrealEngine/Plugin","count":8,"path":"api/categories/UnrealEngine/Plugin.json"}],"tags":[{"name":"UnrealEngine","slug":"UnrealEngine","count":23,"path":"api/tags/UnrealEngine.json"},{"name":"Plugin","slug":"Plugin","count":10,"path":"api/tags/Plugin.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#UE5%E6%96%87%E5%BF%83%E4%B8%80%E8%A8%80%E6%8F%92%E4%BB%B6\"><span class=\"toc-text\">UE5文心一言插件</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#0-github\"><span class=\"toc-text\">0. github</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1\"><span class=\"toc-text\">1. 结构设计</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-%E8%8E%B7%E5%8F%96AccessToken\"><span class=\"toc-text\">2. 获取AccessToken</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%AF%9D%E5%86%85%E5%AE%B9\"><span class=\"toc-text\">3. 获取对话内容</span></a></li></ol></li></ol></li></ol>","author":{"name":"FangH","slug":"blog-author","avatar":"/img/fh.png","link":"/","description":"我曾惊鸿一瞥未来","socials":{"github":"https://github.com/FHangH","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/zi-heng-18-99-47","csdn":"https://blog.csdn.net/weixin_44519692?spm=1000.2115.3001.5343","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"UE5运行环境和平台判断插件","uid":"5c74a20a1969a2b5474b8c37c94903b1","slug":"7_20_UE5运行环境和平台判断插件","date":"2024-02-29T06:19:33.435Z","updated":"2024-02-29T06:18:40.297Z","comments":true,"path":"api/articles/7_20_UE5运行环境和平台判断插件.json","keywords":null,"cover":"https://cdn.jsdelivr.net/gh/FHangH/FHangBlogCDN_03@master/Aurora_ (42).webp","text":"UE5运行环境和平台判断插件[toc] 0. githubUE5运行环境和平台判断插件 1. 结构设计Platform.h 123456789101112131...","permalink":"/post/7_20_UE5运行环境和平台判断插件","photos":[],"count_time":{"symbolsCount":"5.5k","symbolsTime":"5 mins."},"categories":[{"name":"UnrealEngine","slug":"UnrealEngine","count":23,"path":"api/categories/UnrealEngine.json"},{"name":"Plugin","slug":"UnrealEngine/Plugin","count":8,"path":"api/categories/UnrealEngine/Plugin.json"}],"tags":[{"name":"UnrealEngine","slug":"UnrealEngine","count":23,"path":"api/tags/UnrealEngine.json"},{"name":"Plugin","slug":"Plugin","count":10,"path":"api/tags/Plugin.json"}],"author":{"name":"FangH","slug":"blog-author","avatar":"/img/fh.png","link":"/","description":"我曾惊鸿一瞥未来","socials":{"github":"https://github.com/FHangH","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/zi-heng-18-99-47","csdn":"https://blog.csdn.net/weixin_44519692?spm=1000.2115.3001.5343","juejin":"","customs":{}}}},"next_post":{"title":"UE5腾讯AI绘画插件","uid":"736b8df2107eb9f197fd84b43d0b54f0","slug":"7_18_UE5腾讯AI绘画插件","date":"2024-02-29T06:19:33.429Z","updated":"2024-02-29T06:18:20.288Z","comments":true,"path":"api/articles/7_18_UE5腾讯AI绘画插件.json","keywords":null,"cover":"https://cdn.jsdelivr.net/gh/FHangH/FHangBlogCDN_03@master/Aurora_ (40).webp","text":"UE5腾讯AI绘画插件[toc] 0. githubUE5腾讯AI绘画插件 1. 腾讯HTTP V3验证TencentAIArtV3.h 12345678910...","permalink":"/post/7_18_UE5腾讯AI绘画插件","photos":[],"count_time":{"symbolsCount":"17k","symbolsTime":"15 mins."},"categories":[{"name":"UnrealEngine","slug":"UnrealEngine","count":23,"path":"api/categories/UnrealEngine.json"},{"name":"Plugin","slug":"UnrealEngine/Plugin","count":8,"path":"api/categories/UnrealEngine/Plugin.json"}],"tags":[{"name":"UnrealEngine","slug":"UnrealEngine","count":23,"path":"api/tags/UnrealEngine.json"},{"name":"Plugin","slug":"Plugin","count":10,"path":"api/tags/Plugin.json"}],"author":{"name":"FangH","slug":"blog-author","avatar":"/img/fh.png","link":"/","description":"我曾惊鸿一瞥未来","socials":{"github":"https://github.com/FHangH","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/people/zi-heng-18-99-47","csdn":"https://blog.csdn.net/weixin_44519692?spm=1000.2115.3001.5343","juejin":"","customs":{}}}}}